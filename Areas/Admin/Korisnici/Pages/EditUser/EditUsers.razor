@page "/admin/users/edit/{UserId}"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using DodjelaStanovaZG.Components.UI

@attribute [Authorize(Policy = "ImaPristupAdmin")]

<Container BreadcrumbItems="BreadcrumbItems">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" sm="10" md="6" lg="4">
            <MudCard Outlined="true" Class="pa-6">
                <MudCardContent>
                    @if (ErrorMessages?.Count > 0)
                    {
                        <MudAlert Severity="Severity.Error" Elevation="0" Class="mb-4">
                            <ul>
                                @foreach (var msg in ErrorMessages)
                                {
                                    <li>@msg</li>
                                }
                            </ul>
                        </MudAlert>
                    }

                    <MudTabs Color="Color.Default" Rounded="true" PanelClass="pa-6">
                        <!-- TAB 1: Osnovni podaci o korisniku -->
                        <MudTabPanel Text="Korisnički podaci">
                            <MudForm @ref="_editForm" Model="@UserModel"
                                     Valid="@(() => _isValid = true)"
                                     Invalid="@(() => _isValid = false)">

                                <!-- Switch za omogućavanje izmjene podataka -->
                                <MudSwitch T="bool"
                                           @bind-Value="AllowEditing"
                                           Color="Color.Primary"
                                           Class="mb-4"
                                           Label="Omogući izmjenu korisničkih podataka"/>

                                <!-- Korisničko ime -->
                                <MudTextField T="string"
                                              Label="Korisničko ime"
                                              @bind-Value="UserModel.UserName"
                                              Disabled="@(!AllowEditing)"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Class="mb-4"
                                              AutoFocus="true"/>

                                <!-- Email -->
                                <MudTextField T="string"
                                              Label="Email"
                                              @bind-Value="UserModel.Email"
                                              Disabled="@(!AllowEditing)"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Class="mb-4"/>

                                <!-- Switch za zaključavanje/otključavanje računa -->
                                <MudSwitch T="bool"
                                           @bind-Value="UserModel.IsLocked"
                                           Color="Color.Error"
                                           Label="@LockLabel"/>

                                <!-- Gumbi (Spremi, Odustani, Promijeni lozinku) -->
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-4"
                                          Style="width: 100%;">
                                    <MudButton OnClick="@SaveUser"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               Size="Size.Small"
                                               Variant="Variant.Filled"
                                               DropShadow="false"
                                               Color="Color.Default"
                                               Style="border: 1px solid #d3d3d3;"
                                               IconColor="Color.Success">
                                        Spremi
                                    </MudButton>

                                    <MudButton
                                        OnClick="@Cancel"
                                        StartIcon="@Icons.Material.Filled.Cancel"
                                        Size="Size.Small"
                                        Variant="Variant.Filled"
                                        DropShadow="false"
                                        IconColor="Color.Error"
                                        Style="border: 1px solid #d3d3d3;"
                                        Color="Color.Default">
                                        Odustani
                                    </MudButton>

                                    <MudButton
                                        OnClick="@ChangePassword"
                                        StartIcon="@Icons.Material.Filled.LockReset"
                                        Size="Size.Small"
                                        Variant="Variant.Filled"
                                        DropShadow="false"
                                        Color="Color.Default"
                                        Style="border: 1px solid #d3d3d3;"
                                        IconColor="Color.Error">
                                        Promijeni lozinku
                                    </MudButton>
                                </MudStack>
                            </MudForm>
                        </MudTabPanel>

                        <!-- TAB 2: Upravljanje rolama -->
                        <MudTabPanel Text="Role">
                            <EditUserRoles UserId="@UserId"/>
                        </MudTabPanel>
                    </MudTabs>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</Container>