@page "/admin/users"
@attribute [Authorize(Roles = "Admin,SuperAdmin")]

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using DodjelaStanovaZG.Services
@using DodjelaStanovaZG.DTO
@using Microsoft.AspNetCore.Authorization
@using DodjelaStanovaZG.Components.UI

@inject UserManager<IdentityUser> UserManager
@inject IUserService UserService
@inject NavigationManager Navigation

<Container>
    <MudPaper Class="pa-4">
        <!-- Kontejner za pretragu i filter, postavljen horizontalno -->
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <MudTextField Label="Pretraga korisnika"
                          Value="@searchText"
                          ValueChanged="@((string e) => OnValueChanged(e))"
                          Immediate="true"
                          DebounceInterval="300"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" />

            <MudSelect T="string" Label="Role:"
                       @bind-Value="filterRole"
                       @bind-Value:after="OnFilterRoleChanged"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Style="min-width: 120px;">
                <MudSelectItem T="string" Value="@RoleNames.All">@RoleNames.All</MudSelectItem>
                <MudSelectItem T="string" Value="@RoleNames.User">@RoleNames.User</MudSelectItem>
                <MudSelectItem T="string" Value="@RoleNames.Admin">@RoleNames.Admin</MudSelectItem>
                <MudSelectItem T="string" Value="@RoleNames.SuperAdmin">@RoleNames.SuperAdmin</MudSelectItem>
            </MudSelect>
        </div>

        <!-- Tablica s korisničkim podacima -->
        <MudTable T="UserDto"
                  ServerData="LoadUsers"
                  Hover="true"
                  Striped="true"
                  RowsPerPage="@rowsPerPage"
                  Dense="true"
                  Class="my-custom-table"
                  @ref="table">

            <ToolBarContent>
                <MudText Typo="Typo.h6">Lista korisnika</MudText>
                <MudSpacer />
            </ToolBarContent>

            <HeaderContent>
                <MudTh>Username</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Username">@context.UserName</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Roles">@context.Roles</MudTd>
                <MudTd DataLabel="Actions">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => EditUser(@context.Id))">
                        <MudIcon Icon="@Icons.Material.Filled.Edit" /> Edit
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Error" Class="ml-2" OnClick="@(() => DeleteUser(@context.Id))">
                        <MudIcon Icon="@Icons.Material.Filled.Delete" /> Delete
                    </MudButton>
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudPaper>
</Container>


@code {
    // Ref na MudTable
    private MudTable<UserDto> table;

    // Privatna polja za pretragu, filtriranje i broj redova
    private string searchText = "";
    private string filterRole = RoleNames.All;
    private int rowsPerPage = 5;

    /// <summary>
    /// Metoda se poziva kad se mijenja pretraga.
    /// </summary>
    private async Task OnValueChanged(string newValue)
    {
        searchText = newValue;
        if (table != null)
        {
            await table.ReloadServerData();
        }
    }

    /// <summary>
    /// Metoda se poziva kad se mijenja odabrana rola u filteru.
    /// </summary>
    private async Task OnFilterRoleChanged()
    {
        Console.WriteLine($"[FilterRole changed] => {filterRole}");
        if (table != null)
        {
            await table.ReloadServerData();
        }
    }

    /// <summary>
    /// Dohvat podataka server-side uz filtriranje i pretragu.
    /// </summary>
    private async Task<TableData<UserDto>> LoadUsers(TableState state, CancellationToken cancellationToken)
    {
        Console.WriteLine($"LoadUsers => Page={state.Page}, PageSize={state.PageSize}, searchText='{searchText}', filterRole='{filterRole}'");
        // Prosljeđujemo searchText i filterRole u UserService
        return await UserService.GetUsersAsync(UserManager, searchText, filterRole, state, cancellationToken);
    }

    /// <summary>
    /// Navigira na stranicu za uređivanje korisnika.
    /// </summary>
    private void EditUser(string userId)
    {
        Navigation.NavigateTo($"/admin/users/edit/{userId}");
    }

    /// <summary>
    /// Briše korisnika i ponovno učitava tablicu.
    /// </summary>
    private async Task DeleteUser(string userId)
    {
        bool success = await UserService.DeleteUserAsync(UserManager, userId);
        if (success && table != null)
        {
            await table.ReloadServerData();
        }
    }
}
