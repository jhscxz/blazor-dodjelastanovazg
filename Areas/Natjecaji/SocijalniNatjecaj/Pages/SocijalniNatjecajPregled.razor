@page "/socijalni/pregled/{NatjecajId:long}"
@using DodjelaStanovaZG.Areas.Natjecaji.SocijalniNatjecaj.DTO
@using DodjelaStanovaZG.Components.UI
@using DodjelaStanovaZG.Enums
@using MudBlazor
@inherits SocijalniNatjecajPregledBase

<Container BreadcrumbItems="BreadcrumbItems">
    <MudPaper Outlined="true" Class="pa-4">

        <div class="flex items-center gap-4 mb-4">
            <MudButton OnClick="@AddZahtjev"
                       Variant="Variant.Filled"
                       Color="Color.Default"
                       IconColor="Color.Success"
                       DropShadow="false"
                       StartIcon="@Icons.Material.Filled.Add">
                DODAJ
            </MudButton>

            <div class="flex-1">
                <MudTextField Label="Pretraga zahtjeva"
                              Value="@SearchText"
                              ValueChanged="@(EventCallback.Factory.Create<string>(this, OnSearchChanged)!)"
                              Immediate="true"
                              DebounceInterval="300"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Class="w-full"/>
            </div>

            <div class="flex-none w-[160px]">
                <MudSelect T="RezultatObrade?" Label="Osnovanost"
                           Value="@SelectedOsnovanost"
                           ValueChanged="@(EventCallback.Factory.Create<RezultatObrade?>(this, OnOsnovanostChanged))"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Dense="true"
                           Class="w-[200px]">
                    <MudSelectItem T="RezultatObrade?" Value="null">Svi</MudSelectItem>
                    <MudSelectItem T="RezultatObrade?" Value="RezultatObrade.Nepotpun">Nepotpun</MudSelectItem>
                    <MudSelectItem T="RezultatObrade?" Value="RezultatObrade.Neosnovan">Neosnovan</MudSelectItem>
                    <MudSelectItem T="RezultatObrade?" Value="RezultatObrade.Osnovan">Osnovan</MudSelectItem>
                    <MudSelectItem T="RezultatObrade?" Value="RezultatObrade.Greška">Greška</MudSelectItem>
                </MudSelect>

            </div>
        </div>

        <MudTable T="SocijalniNatjecajZahtjevDto"
                  ServerData="LoadServerData"
                  TableLayout="TableLayout.Fixed"
                  Hover="true"
                  Striped="true"
                  Dense="true"
                  RowsPerPage="10"
                  Outlined="true"
                  Breakpoint="Breakpoint.Sm"
                  @ref="Table">

            <HeaderContent>
                <MudTh></MudTh>
                <MudTh>Klasa predmeta</MudTh>
                <MudTh>Prezime i ime</MudTh>
                <MudTh>OIB</MudTh>
                <MudTh>Ukupno bodova</MudTh>
                <MudTh>Osnovanost</MudTh>
                <MudTh>Akcija</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>
                    <MudIconButton Icon="@GetExpandIcon(context)"
                                   OnClick="@(() => ToggleExpand(context.Id))"
                                   Size="Size.Small"/>
                </MudTd>
                <MudTd>@context.KlasaPredmeta</MudTd>
                <MudTd>@FormatString(context.ImePrezime)</MudTd>
                <MudTd>@FormatString(context.Oib)</MudTd>
                <MudTd>@FormatInt(context.Bodovi?.UkupnoBodova)</MudTd>
                <MudTd>@FormatOsnovanost(context.RezultatObrade)</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Info"
                                   Size="Size.Small"
                                   OnClick="@(() => NavigateToDetails(context))"/>
                </MudTd>
            </RowTemplate>

            <ChildRowContent>
                @if (IsRowExpanded(context))
                {
                    <MudTd ColSpan="@TotalColumns">
                        <MudPaper Class="pa-3 rounded-lg" Elevation="1">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Detalji bodovanja</MudText>

                            <MudGrid GutterSize="8px">

                                <!-- STUPAC 1 – Prihodi + članovi -->
                                <MudItem xs="12" sm="6" md="2">
                                    <MudText Typo="Typo.body2"><b>Ukupni
                                            prihod:</b> @FormatPrihod(context.Bodovni?.UkupniPrihodKucanstva)</MudText>
                                    <MudText Typo="Typo.body2"><b>Postotak
                                            prosjeka:</b> @(context.KucanstvoPodaci?.Prihod.PostotakProsjeka?.ToString("0.##") ?? "–")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Ispunjava uvjet
                                            prihoda:</b> @(context.KucanstvoPodaci?.IspunjavaUvjetPrihoda == true ? "Da" : "Ne")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Broj članova:</b> @(context.Clanovi?.Count ?? 0)
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Maloljetni
                                            članovi:</b> @context.Bodovni?.BrojMaloljetneDjece</MudText>
                                </MudItem>

                                <!-- STUPAC 2 – Kućanstvo -->
                                <MudItem xs="12" sm="6" md="2">
                                    <MudText Typo="Typo.body2"><b>Stambeni
                                            status:</b> @FormatString(context.Bodovni?.StambeniStatusKucanstva?.ToString())
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Sastav
                                            kućanstva:</b> @FormatString(context.Bodovni?.SastavKucanstva?.ToString())
                                    </MudText>
                                </MudItem>

                                <!-- STUPAC 3 – Socijalno-zdravstveni status -->
                                <MudItem xs="12" sm="6" md="2">
                                    <MudText Typo="Typo.body2">
                                        <b>ZMN:</b> @(context.Bodovni?.PrimateljZajamceneMinimalneNaknade == true ? "Da" : "Ne")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Roditelj
                                            njegovatelj:</b> @(context.Bodovni?.StatusRoditeljaNjegovatelja == true ? "Da" : "Ne")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Doplatak za
                                            njegu:</b> @(context.Bodovni?.KorisnikDoplatkaZaPomoc == true ? "Da" : "Ne")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Odrasli –
                                            invalidnina:</b> @context.Bodovni?.BrojOdraslihKorisnikaInvalidnine
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Maloljetni –
                                            invalidnina:</b> @context.Bodovni?.BrojMaloljetnihKorisnikaInvalidnine
                                    </MudText>
                                </MudItem>

                                <!-- STUPAC 4 – Osobne okolnosti -->
                                <MudItem xs="12" sm="6" md="2">
                                    <MudText Typo="Typo.body2"><b>Žrtva obiteljskog
                                            nasilja:</b> @(context.Bodovni?.ZrtvaObiteljskogNasilja == true ? "Da" : "Ne")
                                    </MudText>
                                    <MudText Typo="Typo.body2"><b>Alternativna skrb
                                            (18–29):</b> @context.Bodovni?.BrojOsobaUAlternativnojSkrbi</MudText>
                                    <MudText Typo="Typo.body2"><b>Iznad 55
                                            godina:</b> @(context.Bodovni?.PodnositeljIznad55Godina == true ? "Da" : "Ne")
                                    </MudText>
                                </MudItem>

                                <!-- STUPAC 5 – Ratni status -->
                                <MudItem xs="12" sm="6" md="2">
                                    <MudText Typo="Typo.body2"><b>Branitelj –
                                            mjeseci:</b> @context.Bodovni?.BrojMjeseciObranaSuvereniteta</MudText>
                                    <MudText Typo="Typo.body2"><b>Žrtva seksualnog
                                            nasilja:</b> @context.Bodovni?.BrojClanovaZrtavaSeksualnogNasilja</MudText>
                                    <MudText Typo="Typo.body2"><b>Civilni
                                            stradalnik:</b> @context.Bodovni?.BrojCivilnihStradalnika</MudText>
                                </MudItem>

                                <!-- Bodovni sažetak -->
                                <MudItem xs="12">
                                    <MudText Typo="Typo.subtitle2" Class="mt-2">Ukupno bodova:
                                        <b>@FormatInt(context.Bodovi?.UkupnoBodova)</b></MudText>
                                </MudItem>

                            </MudGrid>
                        </MudPaper>


                    </MudTd>
                }
            </ChildRowContent>

            <PagerContent>
                <MudTablePager/>
            </PagerContent>

        </MudTable>
    </MudPaper>
</Container>
